<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Face Login Cross-Device (Firebase)</title>
<style>
Â  body { font-family: sans-serif; text-align: center; margin:0; padding:20px; background:#f5f5f5; }
Â  video, canvas { border-radius:12px; width:100%; max-width:400px; height:auto; }
Â  button { margin:10px 5px; padding:10px 20px; font-size:16px; background:#0078ff; color:white; border:none; border-radius:10px; cursor:pointer; }
Â  button:hover { background:#005ccc; }
Â  input { padding:8px; margin-top:10px; font-size:14px; width:80%; max-width:300px; }
Â  #home-section { display:none; margin-top:50px; }
Â  #status { margin-top:12px; height:24px; }
Â  .success { color:green; }
Â  .error { color:red; }
</style>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

</head>
<body>

<div id="login-section">
Â  <h2>à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸”à¹‰à¸§à¸¢à¹ƒà¸šà¸«à¸™à¹‰à¸² (Cross-Device)</h2>
Â  <div style="position:relative; display:inline-block;">
Â  Â  <video id="camera" autoplay playsinline></video>
Â  Â  <canvas id="overlay" width="400" height="300" style="position:absolute; top:0; left:0;"></canvas>
Â  </div>
Â  <br>
Â  <input id="username" placeholder="à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (à¸ªà¸³à¸«à¸£à¸±à¸šà¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™)"><br>
Â  <button id="registerBtn">à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</button>
Â  <button id="loginBtn">à¸¥à¹‡à¸­à¸à¸­à¸´à¸™</button>
Â  <div id="status"></div>
</div>

<div id="home-section">
Â  <h1>ğŸ‰ à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š!</h1>
Â  <p>à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§</p>
Â  <button onclick="logout()">à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
</div>

<script>
// =========================================================
// FIREBASE CONFIGURATION & INITIALIZATION
// =========================================================
const firebaseConfig = {
Â  apiKey: "AIzaSyB8Z6WMkwr9Rv3yIs4f72RmukTsMXw4NmI",
Â  authDomain: "armngo-60581.firebaseapp.com",
Â  projectId: "armngo-60581",
Â  storageBucket: "armngo-60581.firebasestorage.app",
Â  messagingSenderId: "603474147994",
Â  appId: "1:603474147994:web:78793add40633a937d7d23",
Â  // measurementId: "G-9H05QMMGLV" // à¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
};

// 1. à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Firebase App
firebase.initializeApp(firebaseConfig); 

// 2. à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Realtime Database à¹à¸¥à¸°à¸à¸³à¸«à¸™à¸” Node à¸«à¸¥à¸±à¸
const database = firebase.database();
const faceRef = database.ref('face_users'); // Node à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹€à¸à¹‡à¸š Face Descriptor (à¹€à¸—à¸µà¸¢à¸šà¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¸•à¸²à¸£à¸²à¸‡à¹ƒà¸™ DB)


// =========================================================
// FACE LOGIN CORE LOGIC
// =========================================================
const video = document.getElementById('camera');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const statusEl = document.getElementById('status');

function status(text,type=''){ statusEl.innerHTML=`<span class="${type}">${text}</span>`; }

// à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡
async function startCamera(){
Â  try{
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:false});
Â  Â  video.srcObject = stream;
Â  }catch(err){ alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰: "+err); }
}
startCamera();

// à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥
async function loadModels(){
Â  status('à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥...');
Â  const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
Â  await Promise.all([
Â  Â  faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
Â  Â  faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
Â  Â  faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
Â  ]);
Â  status('à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§');
}
loadModels();

// à¸ˆà¸±à¸š descriptor
async function getFaceDescriptor(){
Â  const options=new faceapi.TinyFaceDetectorOptions({inputSize:224});
Â  const detection = await faceapi.detectSingleFace(video,options).withFaceLandmarks().withFaceDescriptor();
Â  if(!detection) return null;
Â  return detection.descriptor;
}

// overlay
async function drawOverlay(){
Â  if(video.readyState<2) return requestAnimationFrame(drawOverlay);
Â  const options=new faceapi.TinyFaceDetectorOptions({inputSize:224});
Â  const detections=await faceapi.detectAllFaces(video,options).withFaceLandmarks();
Â  ctx.clearRect(0,0,overlay.width,overlay.height);
Â  detections.forEach(det=>{
Â  Â  const box=det.detection.box;
Â  Â  ctx.strokeStyle='lime';
Â  Â  ctx.lineWidth=2;
Â  Â  ctx.strokeRect(box.x,box.y,box.width,box.height);
Â  });
Â  requestAnimationFrame(drawOverlay);
}
drawOverlay();

// =========================================================
// FIREBASE REGISTER & LOGIN IMPLEMENTATION
// =========================================================

// à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ (à¹ƒà¸Šà¹‰ Firebase .set() à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸)
document.getElementById('registerBtn').addEventListener('click',async()=>{
Â  const name=document.getElementById('username').value.trim();
Â  if(!name){ status('à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰','error'); return; }
Â  status('à¸à¸³à¸¥à¸±à¸‡à¸ˆà¸±à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²...');
Â  const desc=await getFaceDescriptor();
Â  if(!desc){ status('à¹„à¸¡à¹ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸² à¸¥à¸­à¸‡à¸›à¸£à¸±à¸šà¸¡à¸¸à¸¡/à¹à¸ªà¸‡','error'); return; }

Â  status('à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¸«à¸™à¹‰à¸²à¹„à¸›à¸—à¸µà¹ˆ Firebase...');
Â  
Â  // **à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸—à¸µà¹ˆ Firebase (Cross-Device)**
Â  try {
Â  Â  // à¹ƒà¸Šà¹‰ child(name) à¹€à¸›à¹‡à¸™ key à¹à¸¥à¸° Array.from(desc) à¹€à¸›à¹‡à¸™ Value
Â  Â  await faceRef.child(name).set(Array.from(desc)); 
Â  Â  status(`à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${name}`, 'success');
Â  } catch(e) {
Â  Â  status(`Error: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${e.message}`, 'error');
Â  }
});

// à¸¥à¹‡à¸­à¸à¸­à¸´à¸™ (à¹ƒà¸Šà¹‰ Firebase .once('value') à¹€à¸à¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)
document.getElementById('loginBtn').addEventListener('click',async()=>{
Â  status('à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²...');
Â  const probe=await getFaceDescriptor();
Â  if(!probe){ status('à¹„à¸¡à¹ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸² à¸¥à¸­à¸‡à¸›à¸£à¸±à¸šà¸¡à¸¸à¸¡/à¹à¸ªà¸‡','error'); return; }
Â  
Â  status('à¸à¸³à¸¥à¸±à¸‡à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¸«à¸™à¹‰à¸²à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸à¸¥à¸²à¸‡...');

Â  // **à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸²à¸ Firebase (Cross-Device)**
Â  const snapshot = await faceRef.once('value');
Â  const db = snapshot.val(); 

Â  if (!db || !Object.keys(db).length) { status('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥', 'error'); return; }

Â  let best={name:null,dist:Infinity};
Â  
Â  // à¹‚à¸„à¹‰à¸”à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²à¹€à¸”à¸´à¸¡
Â  for(const [name,arr] of Object.entries(db)){
Â  Â  const known=new Float32Array(arr);
Â  Â  let d=0;
Â  Â  for(let i=0;i<probe.length;i++){ const diff=probe[i]-known[i]; d+=diff*diff; }
Â  Â  d=Math.sqrt(d);
Â  Â  if(d<best.dist) best={name,dist:d};
Â  }
Â  
Â  const THRESHOLD=0.6;
Â  if(best.dist<=THRESHOLD){
Â  Â  status(`à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${best.name}`,'success');
Â  Â  document.getElementById('login-section').style.display='none';
Â  Â  document.getElementById('home-section').style.display='block';
Â  }else{
Â  Â  status(`à¹„à¸¡à¹ˆà¸à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¸£à¸‡à¸à¸±à¸™ (Dist: ${best.dist.toFixed(3)})`,'error');
Â  }
});

function logout(){
Â  document.getElementById('home-section').style.display='none';
Â  document.getElementById('login-section').style.display='block';
}
</script>
</body>
</html>